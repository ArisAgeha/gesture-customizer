"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Gesture = void 0;

var _utils = require("./utils");

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var GestureFactory = /*#__PURE__*/function () {
  function GestureFactory() {
    _classCallCheck(this, GestureFactory);

    _defineProperty(this, "gestureList", {});

    _defineProperty(this, "isPause", false);

    _defineProperty(this, "MIN_DETECT_DISTANCE", 100);

    this.initListener();
  }

  _createClass(GestureFactory, [{
    key: "registry",
    value: function registry(keyType, gestureAction, callback) {
      var identifier = this.getIdentifier(keyType);
      this.saveGestureHandler(identifier, gestureAction, callback);
    }
  }, {
    key: "remove",
    value: function remove(keyType, callback) {
      var identifier = this.getIdentifier(keyType);
      var targetStore = this.gestureList[identifier];

      if ((0, _utils.isArray)(targetStore)) {
        var targetIndex = targetStore.findIndex(function (handlerStore) {
          return handlerStore.gestureHandler === callback;
        });
        if (targetIndex !== -1) targetStore.splice(targetIndex, 1);
      }
    }
  }, {
    key: "pause",
    value: function pause() {
      this.isPause = true;
    }
  }, {
    key: "resume",
    value: function resume() {
      this.isPause = false;
    }
  }, {
    key: "initListener",
    value: function initListener() {
      var _this = this;

      window.addEventListener('mousedown', function (downEvent) {
        if (_this.isPause) return;

        var mouseType = _this.getMouseTypeFromButtons(downEvent.buttons);

        if (!mouseType) return;
        var keyType = {
          mouseType: mouseType,
          ctrlKey: downEvent.ctrlKey,
          shiftKey: downEvent.shiftKey
        };
        var moveStep = [];
        var moveSlice = {
          x: 0,
          y: 0
        };
        var timer = 0;

        var onMove = function onMove(moveEvent) {
          moveSlice.x += moveEvent.movementX;
          moveSlice.y += moveEvent.movementY;

          if (moveSlice.x > _this.MIN_DETECT_DISTANCE || moveSlice.y > _this.MIN_DETECT_DISTANCE) {
            var direction = _this.getDirection(moveSlice.x, moveSlice.y);

            var latestMoveStep = moveStep[moveStep.length - 1];

            if (moveStep.length > 0 && latestMoveStep.direction === direction) {
              latestMoveStep.deltaX += moveSlice.x;
              latestMoveStep.deltaY += moveSlice.y;
              latestMoveStep.spendTime = Number(Date.now()) - timer;
            } else {
              timer = Number(Date.now());
              moveStep.push({
                deltaX: moveSlice.x,
                deltaY: moveSlice.y,
                direction: direction,
                spendTime: 0
              });
            }

            moveSlice.x = 0;
            moveSlice.y = 0;
          }
        };

        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', function (upEvent) {
          window.removeEventListener('mousemove', onMove);

          _this.checkHandlerList(moveStep, keyType);
        }, {
          once: true
        });
      });
    }
  }, {
    key: "checkHandlerList",
    value: function checkHandlerList(moveStep, keyType) {
      var _this2 = this;

      var identifier = this.getIdentifier(keyType);
      var handlerStore = this.gestureList[identifier];
      if (!(0, _utils.isArray)(handlerStore)) return;
      handlerStore.forEach(function (handler) {
        _this2.checkShouldInvokeHandler(handler, moveStep);
      });
    }
  }, {
    key: "checkShouldInvokeHandler",
    value: function checkShouldInvokeHandler(handler, realMoveStep) {
      var gestureAction = handler.gestureAction,
          gestureHandler = handler.gestureHandler;
      if (gestureAction.length > realMoveStep.length) return;

      for (var i = 0; i < gestureAction.length; i++) {
        var expectedAction = gestureAction[i];
        var realAction = realMoveStep[i];
        var direction = expectedAction.direction,
            maxDistance = expectedAction.maxDistance,
            maxSpendTime = expectedAction.maxSpendTime;
        if (direction !== realAction.direction) return;
        if (maxSpendTime && maxSpendTime < realAction.spendTime) return;
        var realDistance = realAction.direction.length === 1 ? Math.max(realAction.deltaX, realAction.deltaY) : Math.sqrt(Math.pow(realAction.deltaX, 2) + Math.pow(realAction.deltaY, 2));
        if (maxDistance && maxDistance < realDistance) return;
        var minDistance = expectedAction.minDistance ? Math.max(expectedAction.minDistance, this.MIN_DETECT_DISTANCE) : this.MIN_DETECT_DISTANCE;
        if (minDistance > realDistance) return;
        gestureHandler();
      }
    }
  }, {
    key: "getDirection",
    value: function getDirection(x, y) {
      var direction = 'T';
      var tanh225 = Math.tanh(22.5);
      var tanh675 = Math.tanh(67.5);
      if (x === 0) return y > 0 ? 'T' : 'B';
      if (y === 0) return x > 0 ? 'R' : 'L';
      var res = y / x;

      if (y > 0) {
        if (res > tanh675) direction = 'T';else if (tanh675 > res && res > tanh225) direction = 'TR';else if (tanh225 > res && res > -tanh225) direction = 'R';else if (-tanh225 > res && res > -tanh675) direction = 'RB';else direction = 'B';
      } else {
        if (res > tanh675) direction = 'B';else if (tanh675 > res && res > tanh225) direction = 'BL';else if (tanh225 > res && res > -tanh225) direction = 'L';else if (-tanh225 > res && res > -tanh675) direction = 'LT';else direction = 'T';
      }

      return direction;
    }
  }, {
    key: "saveGestureHandler",
    value: function saveGestureHandler(identifier, gestureAction, gestureHandler) {
      if (!(0, _utils.isArray)(this.gestureList[identifier])) {
        this.gestureList[identifier] = [{
          gestureAction: gestureAction,
          gestureHandler: gestureHandler
        }];
      } else if (!this.gestureList[identifier].some(function (handlerStore) {
        return handlerStore.gestureHandler === gestureHandler;
      })) {
        this.gestureList[identifier].push({
          gestureHandler: gestureHandler,
          gestureAction: gestureAction
        });
      }
    }
  }, {
    key: "getMouseTypeFromButtons",
    value: function getMouseTypeFromButtons(buttons) {
      if (buttons === 1) return 'L';else if (buttons === 2) return 'R';else if (buttons === 3) return 'LR';else if (buttons === 4) return 'M';else return null;
    }
  }, {
    key: "getIdentifier",
    value: function getIdentifier(keyType) {
      var mouseType = keyType.mouseType,
          ctrlKey = keyType.ctrlKey,
          shiftKey = keyType.shiftKey;
      return "".concat(ctrlKey ? 'c' : '').concat(shiftKey ? 's' : '').concat(mouseType);
    }
  }]);

  return GestureFactory;
}();

var Gesture = new GestureFactory();
exports.Gesture = Gesture;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC50cyJdLCJuYW1lcyI6WyJHZXN0dXJlRmFjdG9yeSIsImluaXRMaXN0ZW5lciIsImtleVR5cGUiLCJnZXN0dXJlQWN0aW9uIiwiY2FsbGJhY2siLCJpZGVudGlmaWVyIiwiZ2V0SWRlbnRpZmllciIsInNhdmVHZXN0dXJlSGFuZGxlciIsInRhcmdldFN0b3JlIiwiZ2VzdHVyZUxpc3QiLCJ0YXJnZXRJbmRleCIsImZpbmRJbmRleCIsImhhbmRsZXJTdG9yZSIsImdlc3R1cmVIYW5kbGVyIiwic3BsaWNlIiwiaXNQYXVzZSIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJkb3duRXZlbnQiLCJtb3VzZVR5cGUiLCJnZXRNb3VzZVR5cGVGcm9tQnV0dG9ucyIsImJ1dHRvbnMiLCJjdHJsS2V5Iiwic2hpZnRLZXkiLCJtb3ZlU3RlcCIsIm1vdmVTbGljZSIsIngiLCJ5IiwidGltZXIiLCJvbk1vdmUiLCJtb3ZlRXZlbnQiLCJtb3ZlbWVudFgiLCJtb3ZlbWVudFkiLCJNSU5fREVURUNUX0RJU1RBTkNFIiwiZGlyZWN0aW9uIiwiZ2V0RGlyZWN0aW9uIiwibGF0ZXN0TW92ZVN0ZXAiLCJsZW5ndGgiLCJkZWx0YVgiLCJkZWx0YVkiLCJzcGVuZFRpbWUiLCJOdW1iZXIiLCJEYXRlIiwibm93IiwicHVzaCIsInVwRXZlbnQiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwiY2hlY2tIYW5kbGVyTGlzdCIsIm9uY2UiLCJmb3JFYWNoIiwiaGFuZGxlciIsImNoZWNrU2hvdWxkSW52b2tlSGFuZGxlciIsInJlYWxNb3ZlU3RlcCIsImkiLCJleHBlY3RlZEFjdGlvbiIsInJlYWxBY3Rpb24iLCJtYXhEaXN0YW5jZSIsIm1heFNwZW5kVGltZSIsInJlYWxEaXN0YW5jZSIsIk1hdGgiLCJtYXgiLCJzcXJ0IiwibWluRGlzdGFuY2UiLCJ0YW5oMjI1IiwidGFuaCIsInRhbmg2NzUiLCJyZXMiLCJzb21lIiwiR2VzdHVyZSJdLCJtYXBwaW5ncyI6Ijs7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SixXQUFMLENBQWlCSixVQUFqQixFQUE2QnVDLElBQTdCLENBQWtDO0FBQUUvQixVQUFBQSxjQUFjLEVBQWRBLGNBQUY7QUFBa0JWLFVBQUFBLGFBQWEsRUFBYkE7QUFBbEIsU0FBbEM7QUFDSDtBQUNKOzs7NENBRStCa0IsTyxFQUFpQjtBQUM3QyxVQUFJQSxPQUFPLEtBQUssQ0FBaEIsRUFBbUIsT0FBTyxHQUFQLENBQW5CLEtBQ0ssSUFBSUEsT0FBTyxLQUFLLENBQWhCLEVBQW1CLE9BQU8sR0FBUCxDQUFuQixLQUNBLElBQUlBLE9BQU8sS0FBSyxDQUFoQixFQUFtQixPQUFPLElBQVAsQ0FBbkIsS0FDQSxJQUFJQSxPQUFPLEtBQUssQ0FBaEIsRUFBbUIsT0FBTyxHQUFQLENBQW5CLEtBQ0EsT0FBTyxJQUFQO0FBQ1I7OztrQ0FFcUJuQixPLEVBQWtCO0FBQUEsVUFDNUJpQixTQUQ0QixHQUNLakIsT0FETCxDQUM1QmlCLFNBRDRCO0FBQUEsVUFDakJHLE9BRGlCLEdBQ0twQixPQURMLENBQ2pCb0IsT0FEaUI7QUFBQSxVQUNSQyxRQURRLEdBQ0tyQixPQURMLENBQ1JxQixRQURRO0FBRXBDLHVCQUFVRCxPQUFPLEdBQUcsR0FBSCxHQUFTLEVBQTFCLFNBQStCQyxRQUFRLEdBQUcsR0FBSCxHQUFTLEVBQWhELFNBQXFESixTQUFyRDtBQUNIOzs7Ozs7QUFHRSxJQUFNaUQsT0FBTyxHQUFHLElBQUlwRSxjQUFKLEVBQWhCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNBcnJheSB9IGZyb20gJy4vdXRpbHMnO1xyXG5cclxuZXhwb3J0IHR5cGUgR2VzdHVyZUhhbmRsZXIgPSAoKSA9PiB2b2lkO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBHZXN0dXJlTGlzdCB7XHJcbiAgICBba2V5OiBzdHJpbmddOiBHZXN0dXJlSGFuZGxlckl0ZW1bXTtcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgR2VzdHVyZUhhbmRsZXJJdGVtID0ge1xyXG4gICAgZ2VzdHVyZUhhbmRsZXI6IEdlc3R1cmVIYW5kbGVyO1xyXG4gICAgZ2VzdHVyZUFjdGlvbjogR2VzdHVyZUFjdGlvbltdO1xyXG59O1xyXG5cclxuZXhwb3J0IHR5cGUgS2V5VHlwZSA9IHtcclxuICAgIG1vdXNlVHlwZTogJ0wnIHwgJ1InIHwgJ0xSJyB8ICdNJztcclxuICAgIGN0cmxLZXk/OiBib29sZWFuO1xyXG4gICAgc2hpZnRLZXk/OiBib29sZWFuO1xyXG59O1xyXG5cclxuZXhwb3J0IHR5cGUgRGlyZWN0aW9uID0gJ1QnIHwgJ1RSJyB8ICdSJyB8ICdSQicgfCAnQicgfCAnQkwnIHwgJ0wnIHwgJ0xUJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgR2VzdHVyZUFjdGlvbiB7XHJcbiAgICBkaXJlY3Rpb246IERpcmVjdGlvbjtcclxuICAgIG1pbkRpc3RhbmNlPzogbnVtYmVyO1xyXG4gICAgbWF4RGlzdGFuY2U/OiBudW1iZXI7XHJcbiAgICBtYXhTcGVuZFRpbWU/OiBudW1iZXI7XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIE1vdmVTdGVwID0ge1xyXG4gICAgZGVsdGFYOiBudW1iZXI7XHJcbiAgICBkZWx0YVk6IG51bWJlcjtcclxuICAgIGRpcmVjdGlvbjogRGlyZWN0aW9uO1xyXG4gICAgc3BlbmRUaW1lOiBudW1iZXI7XHJcbn07XHJcblxyXG5jbGFzcyBHZXN0dXJlRmFjdG9yeSB7XHJcbiAgICBnZXN0dXJlTGlzdDogR2VzdHVyZUxpc3QgPSB7fTtcclxuICAgIGlzUGF1c2U6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIE1JTl9ERVRFQ1RfRElTVEFOQ0U6IG51bWJlciA9IDEwMDtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLmluaXRMaXN0ZW5lcigpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZ2lzdHJ5KGtleVR5cGU6IEtleVR5cGUsIGdlc3R1cmVBY3Rpb246IEdlc3R1cmVBY3Rpb25bXSwgY2FsbGJhY2s6IEdlc3R1cmVIYW5kbGVyKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgaWRlbnRpZmllciA9IHRoaXMuZ2V0SWRlbnRpZmllcihrZXlUeXBlKTtcclxuICAgICAgICB0aGlzLnNhdmVHZXN0dXJlSGFuZGxlcihpZGVudGlmaWVyLCBnZXN0dXJlQWN0aW9uLCBjYWxsYmFjayk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlKGtleVR5cGU6IEtleVR5cGUsIGNhbGxiYWNrOiBHZXN0dXJlSGFuZGxlcikge1xyXG4gICAgICAgIGNvbnN0IGlkZW50aWZpZXIgPSB0aGlzLmdldElkZW50aWZpZXIoa2V5VHlwZSk7XHJcbiAgICAgICAgY29uc3QgdGFyZ2V0U3RvcmUgPSB0aGlzLmdlc3R1cmVMaXN0W2lkZW50aWZpZXJdO1xyXG4gICAgICAgIGlmIChpc0FycmF5KHRhcmdldFN0b3JlKSkge1xyXG4gICAgICAgICAgICBjb25zdCB0YXJnZXRJbmRleCA9IHRhcmdldFN0b3JlLmZpbmRJbmRleCgoaGFuZGxlclN0b3JlKSA9PiBoYW5kbGVyU3RvcmUuZ2VzdHVyZUhhbmRsZXIgPT09IGNhbGxiYWNrKTtcclxuICAgICAgICAgICAgaWYgKHRhcmdldEluZGV4ICE9PSAtMSkgdGFyZ2V0U3RvcmUuc3BsaWNlKHRhcmdldEluZGV4LCAxKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcGF1c2UoKSB7XHJcbiAgICAgICAgdGhpcy5pc1BhdXNlID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICByZXN1bWUoKSB7XHJcbiAgICAgICAgdGhpcy5pc1BhdXNlID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0TGlzdGVuZXIoKSB7XHJcbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIChkb3duRXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaXNQYXVzZSkgcmV0dXJuO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgbW91c2VUeXBlID0gdGhpcy5nZXRNb3VzZVR5cGVGcm9tQnV0dG9ucyhkb3duRXZlbnQuYnV0dG9ucyk7XHJcbiAgICAgICAgICAgIGlmICghbW91c2VUeXBlKSByZXR1cm47XHJcblxyXG4gICAgICAgICAgICBjb25zdCBrZXlUeXBlOiBLZXlUeXBlID0ge1xyXG4gICAgICAgICAgICAgICAgbW91c2VUeXBlLFxyXG4gICAgICAgICAgICAgICAgY3RybEtleTogZG93bkV2ZW50LmN0cmxLZXksXHJcbiAgICAgICAgICAgICAgICBzaGlmdEtleTogZG93bkV2ZW50LnNoaWZ0S2V5XHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBjb25zdCBtb3ZlU3RlcDogTW92ZVN0ZXBbXSA9IFtdO1xyXG4gICAgICAgICAgICBjb25zdCBtb3ZlU2xpY2UgPSB7IHg6IDAsIHk6IDAgfTtcclxuICAgICAgICAgICAgbGV0IHRpbWVyID0gMDtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IG9uTW92ZSA9IChtb3ZlRXZlbnQ6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgIG1vdmVTbGljZS54ICs9IG1vdmVFdmVudC5tb3ZlbWVudFg7XHJcbiAgICAgICAgICAgICAgICBtb3ZlU2xpY2UueSArPSBtb3ZlRXZlbnQubW92ZW1lbnRZO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChtb3ZlU2xpY2UueCA+IHRoaXMuTUlOX0RFVEVDVF9ESVNUQU5DRSB8fCBtb3ZlU2xpY2UueSA+IHRoaXMuTUlOX0RFVEVDVF9ESVNUQU5DRSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpcmVjdGlvbiA9IHRoaXMuZ2V0RGlyZWN0aW9uKG1vdmVTbGljZS54LCBtb3ZlU2xpY2UueSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGF0ZXN0TW92ZVN0ZXAgPSBtb3ZlU3RlcFttb3ZlU3RlcC5sZW5ndGggLSAxXTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobW92ZVN0ZXAubGVuZ3RoID4gMCAmJiBsYXRlc3RNb3ZlU3RlcC5kaXJlY3Rpb24gPT09IGRpcmVjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXRlc3RNb3ZlU3RlcC5kZWx0YVggKz0gbW92ZVNsaWNlLng7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhdGVzdE1vdmVTdGVwLmRlbHRhWSArPSBtb3ZlU2xpY2UueTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGF0ZXN0TW92ZVN0ZXAuc3BlbmRUaW1lID0gTnVtYmVyKERhdGUubm93KCkpIC0gdGltZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lciA9IE51bWJlcihEYXRlLm5vdygpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbW92ZVN0ZXAucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWx0YVg6IG1vdmVTbGljZS54LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsdGFZOiBtb3ZlU2xpY2UueSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGlvbixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwZW5kVGltZTogMFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgbW92ZVNsaWNlLnggPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIG1vdmVTbGljZS55ID0gMDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBvbk1vdmUpO1xyXG4gICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsICh1cEV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgb25Nb3ZlKTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLmNoZWNrSGFuZGxlckxpc3QobW92ZVN0ZXAsIGtleVR5cGUpO1xyXG5cclxuICAgICAgICAgICAgfSwgeyBvbmNlOiB0cnVlIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tIYW5kbGVyTGlzdChtb3ZlU3RlcDogTW92ZVN0ZXBbXSwga2V5VHlwZTogS2V5VHlwZSkge1xyXG4gICAgICAgIGNvbnN0IGlkZW50aWZpZXIgPSB0aGlzLmdldElkZW50aWZpZXIoa2V5VHlwZSk7XHJcbiAgICAgICAgY29uc3QgaGFuZGxlclN0b3JlID0gdGhpcy5nZXN0dXJlTGlzdFtpZGVudGlmaWVyXTtcclxuICAgICAgICBpZiAoIWlzQXJyYXkoaGFuZGxlclN0b3JlKSkgcmV0dXJuO1xyXG5cclxuICAgICAgICBoYW5kbGVyU3RvcmUuZm9yRWFjaChoYW5kbGVyID0+IHtcclxuICAgICAgICAgICAgdGhpcy5jaGVja1Nob3VsZEludm9rZUhhbmRsZXIoaGFuZGxlciwgbW92ZVN0ZXApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tTaG91bGRJbnZva2VIYW5kbGVyKGhhbmRsZXI6IEdlc3R1cmVIYW5kbGVySXRlbSwgcmVhbE1vdmVTdGVwOiBNb3ZlU3RlcFtdKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgeyBnZXN0dXJlQWN0aW9uLCBnZXN0dXJlSGFuZGxlciB9ID0gaGFuZGxlcjtcclxuICAgICAgICBpZiAoZ2VzdHVyZUFjdGlvbi5sZW5ndGggPiByZWFsTW92ZVN0ZXAubGVuZ3RoKSByZXR1cm47XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBnZXN0dXJlQWN0aW9uLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGV4cGVjdGVkQWN0aW9uID0gZ2VzdHVyZUFjdGlvbltpXTtcclxuICAgICAgICAgICAgY29uc3QgcmVhbEFjdGlvbiA9IHJlYWxNb3ZlU3RlcFtpXTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHsgZGlyZWN0aW9uLCBtYXhEaXN0YW5jZSwgbWF4U3BlbmRUaW1lIH0gPSBleHBlY3RlZEFjdGlvbjtcclxuXHJcbiAgICAgICAgICAgIGlmIChkaXJlY3Rpb24gIT09IHJlYWxBY3Rpb24uZGlyZWN0aW9uKSByZXR1cm47XHJcbiAgICAgICAgICAgIGlmIChtYXhTcGVuZFRpbWUgJiYgbWF4U3BlbmRUaW1lIDwgcmVhbEFjdGlvbi5zcGVuZFRpbWUpIHJldHVybjtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHJlYWxEaXN0YW5jZSA9IHJlYWxBY3Rpb24uZGlyZWN0aW9uLmxlbmd0aCA9PT0gMVxyXG4gICAgICAgICAgICAgICAgPyBNYXRoLm1heChyZWFsQWN0aW9uLmRlbHRhWCwgcmVhbEFjdGlvbi5kZWx0YVkpXHJcbiAgICAgICAgICAgICAgICA6IE1hdGguc3FydChyZWFsQWN0aW9uLmRlbHRhWCAqKiAyICsgcmVhbEFjdGlvbi5kZWx0YVkgKiogMik7XHJcblxyXG4gICAgICAgICAgICBpZiAobWF4RGlzdGFuY2UgJiYgbWF4RGlzdGFuY2UgPCByZWFsRGlzdGFuY2UpIHJldHVybjtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IG1pbkRpc3RhbmNlID0gZXhwZWN0ZWRBY3Rpb24ubWluRGlzdGFuY2UgPyBNYXRoLm1heChleHBlY3RlZEFjdGlvbi5taW5EaXN0YW5jZSwgdGhpcy5NSU5fREVURUNUX0RJU1RBTkNFKSA6IHRoaXMuTUlOX0RFVEVDVF9ESVNUQU5DRTtcclxuICAgICAgICAgICAgaWYgKG1pbkRpc3RhbmNlID4gcmVhbERpc3RhbmNlKSByZXR1cm47XHJcblxyXG4gICAgICAgICAgICBnZXN0dXJlSGFuZGxlcigpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldERpcmVjdGlvbih4OiBudW1iZXIsIHk6IG51bWJlcik6IERpcmVjdGlvbiB7XHJcbiAgICAgICAgbGV0IGRpcmVjdGlvbjogRGlyZWN0aW9uID0gJ1QnO1xyXG4gICAgICAgIGNvbnN0IHRhbmgyMjUgPSBNYXRoLnRhbmgoMjIuNSk7XHJcbiAgICAgICAgY29uc3QgdGFuaDY3NSA9IE1hdGgudGFuaCg2Ny41KTtcclxuICAgICAgICBpZiAoeCA9PT0gMCkgcmV0dXJuIHkgPiAwID8gJ1QnIDogJ0InO1xyXG4gICAgICAgIGlmICh5ID09PSAwKSByZXR1cm4geCA+IDAgPyAnUicgOiAnTCc7XHJcblxyXG4gICAgICAgIGNvbnN0IHJlcyA9IHkgLyB4O1xyXG5cclxuICAgICAgICBpZiAoeSA+IDApIHtcclxuICAgICAgICAgICAgaWYgKHJlcyA+IHRhbmg2NzUpIGRpcmVjdGlvbiA9ICdUJztcclxuICAgICAgICAgICAgZWxzZSBpZiAodGFuaDY3NSA+IHJlcyAmJiByZXMgPiB0YW5oMjI1KSBkaXJlY3Rpb24gPSAnVFInO1xyXG4gICAgICAgICAgICBlbHNlIGlmICh0YW5oMjI1ID4gcmVzICYmIHJlcyA+IC10YW5oMjI1KSBkaXJlY3Rpb24gPSAnUic7XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKC10YW5oMjI1ID4gcmVzICYmIHJlcyA+IC10YW5oNjc1KSBkaXJlY3Rpb24gPSAnUkInO1xyXG4gICAgICAgICAgICBlbHNlIGRpcmVjdGlvbiA9ICdCJztcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChyZXMgPiB0YW5oNjc1KSBkaXJlY3Rpb24gPSAnQic7XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKHRhbmg2NzUgPiByZXMgJiYgcmVzID4gdGFuaDIyNSkgZGlyZWN0aW9uID0gJ0JMJztcclxuICAgICAgICAgICAgZWxzZSBpZiAodGFuaDIyNSA+IHJlcyAmJiByZXMgPiAtdGFuaDIyNSkgZGlyZWN0aW9uID0gJ0wnO1xyXG4gICAgICAgICAgICBlbHNlIGlmICgtdGFuaDIyNSA+IHJlcyAmJiByZXMgPiAtdGFuaDY3NSkgZGlyZWN0aW9uID0gJ0xUJztcclxuICAgICAgICAgICAgZWxzZSBkaXJlY3Rpb24gPSAnVCc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZGlyZWN0aW9uO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2F2ZUdlc3R1cmVIYW5kbGVyKGlkZW50aWZpZXI6IHN0cmluZywgZ2VzdHVyZUFjdGlvbjogR2VzdHVyZUFjdGlvbltdLCBnZXN0dXJlSGFuZGxlcjogR2VzdHVyZUhhbmRsZXIpIHtcclxuICAgICAgICBpZiAoIWlzQXJyYXkodGhpcy5nZXN0dXJlTGlzdFtpZGVudGlmaWVyXSkpIHtcclxuICAgICAgICAgICAgdGhpcy5nZXN0dXJlTGlzdFtpZGVudGlmaWVyXSA9IFtcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBnZXN0dXJlQWN0aW9uLFxyXG4gICAgICAgICAgICAgICAgICAgIGdlc3R1cmVIYW5kbGVyXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIF07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKCF0aGlzLmdlc3R1cmVMaXN0W2lkZW50aWZpZXJdLnNvbWUoKGhhbmRsZXJTdG9yZSkgPT4gaGFuZGxlclN0b3JlLmdlc3R1cmVIYW5kbGVyID09PSBnZXN0dXJlSGFuZGxlcikpIHtcclxuICAgICAgICAgICAgdGhpcy5nZXN0dXJlTGlzdFtpZGVudGlmaWVyXS5wdXNoKHsgZ2VzdHVyZUhhbmRsZXIsIGdlc3R1cmVBY3Rpb24gfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0TW91c2VUeXBlRnJvbUJ1dHRvbnMoYnV0dG9uczogbnVtYmVyKSB7XHJcbiAgICAgICAgaWYgKGJ1dHRvbnMgPT09IDEpIHJldHVybiAnTCc7XHJcbiAgICAgICAgZWxzZSBpZiAoYnV0dG9ucyA9PT0gMikgcmV0dXJuICdSJztcclxuICAgICAgICBlbHNlIGlmIChidXR0b25zID09PSAzKSByZXR1cm4gJ0xSJztcclxuICAgICAgICBlbHNlIGlmIChidXR0b25zID09PSA0KSByZXR1cm4gJ00nO1xyXG4gICAgICAgIGVsc2UgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRJZGVudGlmaWVyKGtleVR5cGU6IEtleVR5cGUpIHtcclxuICAgICAgICBjb25zdCB7IG1vdXNlVHlwZSwgY3RybEtleSwgc2hpZnRLZXkgfSA9IGtleVR5cGU7XHJcbiAgICAgICAgcmV0dXJuIGAke2N0cmxLZXkgPyAnYycgOiAnJ30ke3NoaWZ0S2V5ID8gJ3MnIDogJyd9JHttb3VzZVR5cGV9YDtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IEdlc3R1cmUgPSBuZXcgR2VzdHVyZUZhY3RvcnkoKTsiXX0=